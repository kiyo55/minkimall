<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>

<link rel="icon" href="/img/img2/favicon.png" type="image/png">
<title>ì „ì²´ ì£¼ë¬¸ëª©ë¡</title>
</head>
<body>
<div th:replace="include/top"></div>
<section>
<br>
<div align="center">

<h1 th:text="'ì „ì²´ ì£¼ë¬¸ëª©ë¡ (' + ${lisize} + 'ê±´)'">orderList</h1>

<div class="allOrdCtn">

<div style="width: 100%; margin-bottom: 10px">
ì£¼ë¬¸ìƒíƒœë³„ <span style="font-weight: bold;">ì£¼ë¬¸ ê±´ìˆ˜ ë° ë¹„ì¤‘</span>:
</div>

<div id="statusBar" class="sttBar">
	
    <div th:each="cnt : ${cntLi}" id="eachStatus" 
         th:style="'width:' + ${cnt.perStatus} + '%; display: flex; align-items: center; 
         justify-content: center; padding: 5px; text-align: center;'">
         
        <a th:text="${cnt.ostatus} + ' (' + ${cnt.cntStatus} + 'ê±´, ' + ${cnt.perStatus} + '%)'" class="bijung"></a>
    </div>
</div>

<div style="width: 100%; display: flex; justify-content: flex-end; margin-bottom: 30px;">
    <button type="button" class="addPrdBtn">ğŸ” ê²€ìƒ‰</button>
</div>

	<table style="width: 1200px;">
		<tr class="tr_color">
		
			<th>no</th>
			<th>ê²°ì œë²ˆí˜¸</th>			
			<th>ì£¼ë¬¸ë²ˆí˜¸</th>				
			<th>pcode</th>
			<th>ìƒí’ˆëª…</th>
			
		    <th>íŒë§¤ê°€</th>		    
		    <th>ìˆ˜ëŸ‰</th>	
		    <th>ë°°ì†¡ë¹„</th>			    
		    <th>from</th>
		    <th>to</th>
		    
		    <th>ì£¼ë¬¸ì¼</th>		    
		    <th>ì—…ëƒì¼</th>		    
		    <th>rv</th>
		    <th>ìƒíƒœ</th>
		</tr>
			
		<tr th:each="m, stat : ${li}" class="tr_color">	
			
			<td th:text="${stat.count}"></td>
			<td th:text="${m.paynum}"/>			
			<td th:text="${m.oid}"/>		
			<td th:text="${m.product_code}"/>		
			<td th:text="${m.pname}"/>		
			<td th:text="${m.fmtPprice} + 'ì›'"/>		
			
			<td th:text="${m.pquantity}"/>	
			<td th:text="${m.fmtPdelifee} + 'ì›'"/>	
			<td th:text="${m.uname}"/>
			<td th:text="${m.oname}"/>
			<td th:text="${m.fmtDateOnly}"/>
			<td th:text="${m.fmtOtime}"/>
			<td th:text="${m.beReviewed == 1 ? 'Y' : 'N'}"/>
			
			<td>
				<form action="/ord/updOrdStatus" method="post" 
				onsubmit="return validateStatusChange(this);">
				
	                <select class="selectStatus" name="ostatus" id="orderStatus">

	                    <option th:value="${m.ostatus}" th:text="${m.ostatus}"></option>
	                    
	                    <option value="ê²°ì œì™„ë£Œ">ê²°ì œì™„ë£Œ</option>
	                    <option value="ìƒí’ˆì¤€ë¹„">ìƒí’ˆì¤€ë¹„</option>
	                    <option value="ë°œì†¡ì™„ë£Œ">ë°œì†¡ì™„ë£Œ</option>
	                    <option value="ë„ì°©">ë„ì°©</option>
	                    <option value="í™˜ë¶ˆ">í™˜ë¶ˆ</option>
	                </select>&nbsp;
                
					<!-- ê¸°ì¡´ ìƒíƒœ (ì„œë²„ì—ì„œ ë™ì ìœ¼ë¡œ ë Œë”ë§) -->
					<input type="hidden" id="currentStatus" th:value="${m.ostatus}"> 
	                <input type="hidden" name="oid" th:value="${m.oid}">
	                
					<button type="submit" class="subbtnsmall">ë³€ê²½</button>
				</form>
			</td>
		</tr>		
	</table>

<div id="changeStatusSucceed" class="changeStatusSucceed" style="display: none;">
ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.
</div>

<div id="changeStatusFailed" class="changeStatusFailed" style="display: none;">
ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.
</div>

</div>
<br>
</div>    
</section>
<div  th:replace="include/bottom::footer"></div>

<script>
//ìƒíƒœ ë³€ê²½
    function validateStatusChange(form) {
        const currentStatus = document.getElementById('currentStatus').value;
        const selectedStatus = form.ostatus.value;

        // ë³€ê²½ì‚¬í•­ì´ ì—†ì„ ë•Œ
        if (currentStatus === selectedStatus) {
            showFailedPopup();
            return false; // í¼ ì œì¶œ ì¤‘ë‹¨
        }

        // ë³€ê²½ë˜ì—ˆì„ ë•Œ í¼ ì œì¶œ í›„ ì„±ê³µ íŒì—… ë„ìš°ê¸°
        const xhr = new XMLHttpRequest();
        xhr.open(form.method, form.action, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        
        xhr.onload = function () {
            if (xhr.status === 200) {
                showSuccessPopup();
            }
        };

        // í¼ ë°ì´í„°ë¥¼ ì§ë ¬í™”í•˜ê³  ì„œë²„ë¡œ ì „ì†¡
        const formData = new FormData(form);
        const params = new URLSearchParams(formData).toString();
        xhr.send(params);

        return false; // í¼ ì œì¶œ ì¤‘ë‹¨ (AJAXë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ)
    }

    function showSuccessPopup() {
        const popup = document.getElementById('changeStatusSucceed');
        popup.style.display = 'block';
        popup.classList.add('show');
        
        setTimeout(function() {
            popup.classList.remove('show');
            popup.style.display = 'none';
        }, 5000); // íŒì—…ì´ 5ì´ˆ í›„ì— ì‚¬ë¼ì§
    }

    function showFailedPopup() {
        const popup = document.getElementById('changeStatusFailed');
        popup.style.display = 'block';
        popup.classList.add('show');

        setTimeout(function() {
            popup.classList.remove('show');
            popup.style.display = 'none';
        }, 5000); // íŒì—…ì´ 5ì´ˆ í›„ì— ì‚¬ë¼ì§
    }
</script>

<script>
//ë¹„ì¤‘ ì‹œê°í™”
    document.addEventListener('DOMContentLoaded', function() {
        const allStatus = document.querySelectorAll('#eachStatus');

        allStatus.forEach(function(statusBar) {
            const pastelColor = generatePastelColor();
            statusBar.style.backgroundColor = pastelColor;
        });

        // íŒŒìŠ¤í…” ìƒ‰ìƒ ìƒì„± í•¨ìˆ˜
        function generatePastelColor() {
            const r = Math.floor((Math.random() * 127) + 127);  // 127 ~ 255 ë²”ìœ„ì—ì„œ ëœë¤ ê°’ (ë°ì€ ë¹¨ê°•)
            const g = Math.floor((Math.random() * 127) + 127);  // 127 ~ 255 ë²”ìœ„ì—ì„œ ëœë¤ ê°’ (ë°ì€ ì´ˆë¡)
            const b = Math.floor((Math.random() * 127) + 127);  // 127 ~ 255 ë²”ìœ„ì—ì„œ ëœë¤ ê°’ (ë°ì€ íŒŒë‘)

            return `rgb(${r}, ${g}, ${b})`;
        }   
    });
</script>

</body>
</html>